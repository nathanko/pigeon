<html>
<head>
  <!-- TODO: Serve this page over HTTPS -->
  <title>Slingshot</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body style="background:#fff">

  <div class="container ">
    <div class="page-header" style="text-align:center;">
      <h1>Slingshot <small>Send a file.</small></h1>
    </div>

    <div id="upload" class="col-lg-5 col-lg-offset-1" style="border-right:1px solid #ddd;">
    	<h2>Upload.</h2>
    <!--   <input type="text" id="stringInput" placeholder="Enter text here">
      <button onclick="putMessage()" class="btn btn-primary">Put Message</button>
      <br> -->

      <div class="form-inline-NOT">
        <!-- TODO: Add legacy support for IE -->
        <label class="btn btn-default btn-file col-lg-12">
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Choose a file...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
          <input type="file" id="fileInput" style="display:none">
        </label>
        <input type="text" id="passphraseUpload" placeholder="Passphrase" class="form-control">
        <div>&nbsp;</div>
        <button onclick="putFile()" class="btn btn-primary pull-right">Upload</button>
      </div>
    </div>
    <div id="download" class="col-lg-5">
      <h2>Download.</h2>
      <div class="form-inline-NOT">
        <input type="text" id="filename" placeholder="File name" class="form-control">
        <input type="text" id="passphrase" placeholder="Passphrase" class="form-control">
        <div>&nbsp;</div>
        <button onclick="getFile()" class="btn btn-primary pull-right">Download</button>
        <div id="content" class=""></div>
      </div>
    </div>
  </div>

</body>
<script src="https://www.gstatic.com/firebasejs/4.1.1/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
  	apiKey: "AIzaSyDekqVZg1WnLisD6O50vJL_TmD6X-9LKFI", //Should this be here??
  	authDomain: "slingshot-1760f.firebaseapp.com",
  	databaseURL: "https://slingshot-1760f.firebaseio.com",
  	projectId: "slingshot-1760f",
  	storageBucket: "slingshot-1760f.appspot.com",
  	messagingSenderId: "724529158971"
  };
  firebase.initializeApp(config);

  var storage = firebase.storage();
  var storageRef = storage.ref();
  var dataRef = storageRef.child('data');

  console.log("fb ready");

  function putMessage(){
    // Raw string is the default if no format is provided
    var str = document.getElementById("stringInput").value;
    dataRef.child("message.txt").putString(str).then(function(snapshot) {
    	console.log("Uploaded string: "+str);
    });
  }
  function putFile(){
    var file = document.getElementById("fileInput").files[0];
    var metadata = {
      contentType: file.type,
      customMetadata: {
        "pass":"letmein", 
        "destroyOn":"999999999" //TODO: add server-side function to purge
      }
    };
    dataRef.child(file.name).put(file, metadata).then(function(snapshot) {
    console.log("Uploaded file: "+file.name);
    });
  }
  function getFile(){
    console.log("getFile");
    var filename = document.getElementById("filename").value;
    var passphrase = document.getElementById("passphrase").value; //TODO: add server-side function to authenticate download request
    var filepath = dataRef.child(filename).getDownloadURL().then(function(url) {
      console.log("Got url: "+url);
      document.getElementById("content").innerHTML = "<a href='"+url+"' target='blank'><button class='btn btn-secondary pull-right'>Click here</button></a>";
    }).catch(function(error) {
      console.error(error.message_);
      document.getElementById("content").innerHTML = error.message_;
    });
  }
  function hi(){console.log("hi")}

</script>
</html>